<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Catalogue produits</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root{ --bg:#0b0c10; --card:#121318; --text:#e6e6e6; --muted:#a4a7ae; --accent:#4f46e5; --accent-2:#22c55e; --border:#22242c; --shadow:0 10px 25px rgba(0,0,0,.35); --radius:14px; --gap:1rem }
      :root.light{ --bg:#f7f7fb; --card:#ffffff; --text:#0b0c10; --muted:#61646b; --border:#e7e7ef; --shadow:0 10px 25px rgba(10,10,30,.08) }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility}
      .container{max-width:1100px; margin:0 auto; padding:16px}
      .site-header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(180%) blur(8px); background:color-mix(in oklab, var(--bg), transparent 35%); border-bottom:1px solid var(--border)}
      .header-inner{display:flex; align-items:center; justify-content:space-between}
      .brand{margin:0; font-weight:700; letter-spacing:.3px}
      .actions{display:flex; gap:.5rem}
      .btn{background:var(--accent); color:#fff; border:none; padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:var(--shadow)}
      .btn:hover{filter:brightness(1.05)}
      .btn-ghost{background:transparent; border:1px solid var(--border); color:var(--text); box-shadow:none}
      .btn-ghost:hover{background:color-mix(in oklab, var(--text), transparent 90%)}
      .toolbar{display:flex; align-items:center; justify-content:space-between; gap:1rem; margin:18px 0 8px; flex-wrap:wrap}
      .filters{display:flex; gap:.6rem; flex-wrap:wrap}
      .input-group{display:flex; align-items:center; gap:.4rem; background:var(--card); border:1px solid var(--border); padding:.55rem .7rem; border-radius:12px; color:var(--muted)}
      .input-group input{background:transparent; border:none; outline:none; color:var(--text); min-width:220px}
      select{background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:.55rem .7rem; min-width:160px}
      .count-badge{color:var(--muted)}
      .grid{display:grid; grid-template-columns:repeat(1, minmax(0,1fr)); gap:var(--gap)}
      @media (min-width:540px){ .grid{ grid-template-columns:repeat(2, minmax(0,1fr)) } }
      @media (min-width:900px){ .grid{ grid-template-columns:repeat(3, minmax(0,1fr)) } }
      .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column}
      .image-wrap{position:relative; width:100%; padding-top:66%; background:linear-gradient(180deg, #22242c, #1a1c24)}
      .image{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
      .content{padding:14px 14px 12px}
      .title{margin:0 0 6px 0; font-size:1rem}
      .desc{margin:0 0 10px 0; color:var(--muted); font-size:.95rem}
      .meta{display:flex; align-items:center; justify-content:space-between}
      .price{font-weight:700; color:var(--accent)}
      .stock{font-size:.9rem; color:var(--muted)}
      .stock.ok{color:var(--accent-2)}
      .stock.ko{color:#ef4444}
      .line-clamp-2{display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
      .skeleton .image-wrap{background:linear-gradient(90deg, #1b1d24, #232533, #1b1d24); background-size:200% 100%; animation:shimmer 1.2s infinite}
      .skeleton .line{height:12px; background:linear-gradient(90deg, #1b1d24, #232533, #1b1d24); background-size:200% 100%; border-radius:8px; margin:10px 0; animation:shimmer 1.2s infinite}
      .skeleton .w-70{width:70%} .skeleton .w-100{width:100%} .skeleton .w-50{width:50%}
      @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
      .error{margin:18px 0; padding:14px; border:1px solid var(--border); border-radius:12px; background:color-mix(in oklab, #ef4444, transparent 80%)}
      code{display:block; color:var(--muted); font-size:.85rem; overflow:auto}
      .site-footer{border-top:1px solid var(--border); margin-top:28px}
      .site-footer p{color:var(--muted)}
      :focus-visible{outline:2px solid color-mix(in oklab, var(--accent), white 20%); outline-offset:2px}
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <h1 class="brand">Catalogue</h1>
        <div class="actions">
          <button id="themeToggle" class="btn btn-ghost" aria-label="Basculer le th√®me"><span class="sun">‚òÄÔ∏è</span><span class="moon">üåô</span></button>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="toolbar">
        <div class="filters">
          <div class="input-group">
            <span class="icon">üîé</span>
            <input id="searchInput" type="search" placeholder="Rechercher un produit‚Ä¶" aria-label="Rechercher" />
          </div>
          <select id="categorySelect" aria-label="Cat√©gorie">
            <option value="">Toutes les cat√©gories</option>
          </select>
          <select id="availabilitySelect" aria-label="Disponibilit√©">
            <option value="">Tous</option>
            <option value="true">Disponible</option>
            <option value="false">Indisponible</option>
          </select>
          <select id="sortSelect" aria-label="Tri">
            <option value="date_desc">Nouveaut√©s</option>
            <option value="price_asc">Prix: bas ‚Üí haut</option>
            <option value="price_desc">Prix: haut ‚Üí bas</option>
            <option value="name_asc">Nom: A ‚Üí Z</option>
            <option value="name_desc">Nom: Z ‚Üí A</option>
          </select>
        </div>
        <div id="countBadge" class="count-badge" aria-live="polite"></div>
      </section>

      <section id="grid" class="grid" aria-busy="true"></section>

      <template id="cardTemplate">
        <article class="card">
          <div class="image-wrap">
            <img class="image" alt="" loading="lazy" />
          </div>
          <div class="content">
            <h3 class="title"></h3>
            <p class="desc line-clamp-2"></p>
            <div class="meta">
              <span class="price"></span>
              <span class="stock"></span>
            </div>
          </div>
        </article>
      </template>

      <template id="skeletonTemplate">
        <article class="card skeleton">
          <div class="image-wrap"></div>
          <div class="content">
            <div class="line w-70"></div>
            <div class="line w-100"></div>
            <div class="line w-50"></div>
          </div>
        </article>
      </template>

      <div id="error" class="error" hidden>
        <p>Impossible de charger les produits. <button id="retryBtn" class="btn">R√©essayer</button></p>
        <code id="errorDetail"></code>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>¬© <span id="year"></span> Catalogue</p>
      </div>
    </footer>

    <script>
      const API_BASE = "https://catalogue-z1qv.onrender.com";
      const $ = (s, el=document) => el.querySelector(s);
      const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
      const state = { products: [], categories: [], filters: { q:"", category:"", availability:"", sort:"date_desc" } };
      const els = { grid: $("#grid"), countBadge: $("#countBadge"), search: $("#searchInput"), cat: $("#categorySelect"), availability: $("#availabilitySelect"), sort: $("#sortSelect"), error: $("#error"), errorDetail: $("#errorDetail"), retry: $("#retryBtn"), year: $("#year"), themeToggle: $("#themeToggle"), cardTpl: $("#cardTemplate"), skeletonTpl: $("#skeletonTemplate") };

      function formatPrice(v){ if(v==null || Number.isNaN(Number(v))) return ""; return new Intl.NumberFormat("fr-FR", {style:"currency", currency:"EUR"}).format(Number(v)); }
      function formatStock(stock, isAvailable){ if(isAvailable===false) return {text:"Indisponible", cls:"ko"}; if(stock==null) return {text:"‚Äî", cls:""}; if(Number(stock)<=0) return {text:"Rupture", cls:"ko"}; if(Number(stock)<5) return {text:`Stock bas (${stock})`, cls:""}; return {text:"En stock", cls:"ok"}; }
      function productImageUrl(p){ if(p?.image_url){ if(p.image_url.startsWith("http")) return p.image_url; return `${API_BASE}${p.image_url.startsWith("/")?"":"/"}${p.image_url}` } return `https://picsum.photos/seed/${encodeURIComponent(p.slug||p.id)}/600/400` }

      function setThemeFromPref(){ const pref = localStorage.getItem("theme") || (matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"); document.documentElement.classList.toggle("light", pref==="light"); }
      function toggleTheme(){ const isLight = document.documentElement.classList.toggle("light"); localStorage.setItem("theme", isLight?"light":"dark"); }

      function showError(err){ els.error.hidden=false; els.errorDetail.textContent = (err && (err.message||err.statusText)) || String(err||"Erreur"); }
      function hideError(){ els.error.hidden=true; els.errorDetail.textContent="" }

      function renderSkeletons(n=9){ els.grid.setAttribute("aria-busy","true"); els.grid.innerHTML=""; const frag=document.createDocumentFragment(); for(let i=0;i<n;i++){ frag.appendChild(els.skeletonTpl.content.cloneNode(true)); } els.grid.appendChild(frag); }

      function renderProducts(list){ els.grid.setAttribute("aria-busy","false"); els.grid.innerHTML=""; const frag=document.createDocumentFragment(); for(const p of list){ const node = els.cardTpl.content.cloneNode(true); const img=$(".image", node), title=$(".title", node), desc=$(".desc", node), price=$(".price", node), stock=$(".stock", node); img.src=productImageUrl(p); img.alt=p.name||"Produit"; title.textContent=p.name||"Sans nom"; desc.textContent=p.description||""; price.textContent=formatPrice(p.price); const s=formatStock(p.stock, p.is_available); stock.textContent=s.text; if(s.cls) stock.classList.add(s.cls); frag.appendChild(node); } els.grid.appendChild(frag); els.countBadge.textContent = `${list.length} produit${list.length>1?"s":""}`; }

      function applyFilters(){ const {q,category,availability,sort}=state.filters; let list=state.products.slice(); if(q){ const ql=q.toLowerCase(); list=list.filter(p=> (p.name&&p.name.toLowerCase().includes(ql)) || (p.description&&p.description.toLowerCase().includes(ql)) || (p.category_name&&p.category_name.toLowerCase().includes(ql)) ); }
        if(category){ list=list.filter(p=> String(p.category_id)===String(category) || p.category_slug===category); }
        if(availability){ const want = availability==="true"; list=list.filter(p=> Boolean(p.is_available)===want); }
        switch (sort){
          case "price_asc": list.sort((a,b)=>(a.price??Infinity)-(b.price??Infinity)); break;
          case "price_desc": list.sort((a,b)=>(b.price??-Infinity)-(a.price??-Infinity)); break;
          case "name_asc": list.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""),"fr")); break;
          case "name_desc": list.sort((a,b)=>String(b.name||"").localeCompare(String(a.name||""),"fr")); break;
          default: list.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
        }
        renderProducts(list);
      }

      async function fetchJson(url){ const res = await fetch(url, { headers:{accept:"application/json"} }); if(!res.ok) throw new Error(`${res.status} ${res.statusText}`); return res.json(); }
      async function loadCategories(){ const cats = await fetchJson(`${API_BASE}/categories`); state.categories=cats||[]; const options = '<option value="">Toutes les cat√©gories</option>' + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join(""); document.getElementById("categorySelect").innerHTML = options; }
      async function loadProducts(){ const products = await fetchJson(`${API_BASE}/products-all`); state.products = Array.isArray(products)?products:[]; }

      function restoreFromQuery(){ const params=new URLSearchParams(location.search); state.filters.q=params.get("q")||""; state.filters.category=params.get("cat")||""; state.filters.availability=params.get("avail")||""; state.filters.sort=params.get("sort")||"date_desc"; els.search.value=state.filters.q; els.cat.value=state.filters.category; els.availability.value=state.filters.availability; els.sort.value=state.filters.sort; }
      function syncQuery(){ const p=new URLSearchParams(); if(state.filters.q) p.set("q", state.filters.q); if(state.filters.category) p.set("cat", state.filters.category); if(state.filters.availability) p.set("avail", state.filters.availability); if(state.filters.sort && state.filters.sort!=="date_desc") p.set("sort", state.filters.sort); history.replaceState(null, "", "?"+p.toString()); }

      function wireEvents(){ els.search.addEventListener("input", debounce(()=>{ state.filters.q=els.search.value.trim(); syncQuery(); applyFilters(); },200)); els.cat.addEventListener("change", ()=>{ state.filters.category=els.cat.value; syncQuery(); applyFilters(); }); els.availability.addEventListener("change", ()=>{ state.filters.availability=els.availability.value; syncQuery(); applyFilters(); }); els.sort.addEventListener("change", ()=>{ state.filters.sort=els.sort.value; syncQuery(); applyFilters(); }); els.retry.addEventListener("click", init); els.themeToggle.addEventListener("click", toggleTheme); }
      function debounce(fn, wait=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); } }

      async function init(){ try{ hideError(); renderSkeletons(9); setThemeFromPref(); els.year.textContent=new Date().getFullYear(); restoreFromQuery(); wireEvents(); await Promise.all([loadCategories(), loadProducts()]); applyFilters(); }catch(err){ showError(err); } }
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
